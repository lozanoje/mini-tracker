<div id="lvk-mini-tracker">
    {{#if hasCombat}}
    <div class="__inner {{innerCss}}">
        <div class="__resizer"></div>

        <header>
            <a class="combat-control" data-control="rollAll" title="{{localize 'COMBAT.RollAll'}}">
                <i class="fas fa-users"></i>
            </a>
            {{#if user.isGM}}
            <a class="combat-control" data-control="rollNPC" title="{{localize 'COMBAT.RollNPC'}}">
                <i class="fas fa-users-cog"></i>
            </a>
            <a class="combat-control" data-control="resetAll" title="{{localize 'COMBAT.InitiativeReset'}}">
                <i class="fas fa-undo"></i>
            </a>
            {{/if}}

            <span class="draggable">
                {{#if round}}{{localize 'COMBAT.Round'}} {{round}}{{else}}{{localize 'COMBAT.NotStarted'}}{{/if}}
            </span>

            {{#if user.isGM}}
            <a data-control="trackerSettings" title="{{localize 'COMBAT.Settings'}}">
                <i class="fas fa-cog"></i>
            </a>
            {{/if}}
            <a data-control="trackerReverse" title="{{localize 'mini-tracker.reverse'}}">
                <i class="fas fa-arrows-alt-v"></i>
            </a>
            <a data-control="trackerExpand" title="{{localize 'mini-tracker.expand'}}">
                <i class="fas fa-expand"></i>
            </a>
        </header>

        <ol>
            {{#each turns}}
            <li class="combatant {{this.css}}" data-combatant-id="{{this.id}}">
                <img src="{{this.img}}" alt="{{this.name}}" />

                <div class="__details">
                    <h4>{{this.name}}</h4>

                    <div class="__icons">
                        {{#if @root.user.isGM}}
                        <a class="combatant-control{{#if this.hidden}} active{{/if}}" data-control="toggleHidden">
                            <i class="fas fa-eye-slash"></i>
                        </a>
                        {{#if (and @root.canHideNames (not this.hasPlayerOwner))}}
                        <a
                            class="combatant-control{{#if this.playersCanSeeName}} active{{/if}}"
                            data-control="toggle-name-visibility"
                        >
                            <i class="fa-solid fa-signature"></i>
                        </a>
                        {{/if}}
                        <a class="combatant-control{{#if this.defeated}} active{{/if}}" data-control="toggleDefeated">
                            <i class="fas fa-skull"></i>
                        </a>
                        {{/if}} {{#if this.canPing}}
                        <a class="combatant-control" data-control="pingCombatant">
                            <i class="fa-solid fa-bullseye-arrow"></i>
                        </a>
                        {{/if}}

                        <div class="__effects">
                            {{#each this.effects}}
                            <img src="{{this}}" />
                            {{/each}}
                        </div>
                    </div>
                </div>

                <div class="__initiative">
                    {{#if this.hasRolled}}
                    <span>{{this.initiative}}</span>
                    {{else if this.owner}}
                    <a class="__roll combatant-control" data-control="rollInitiative"></a>
                    {{/if}}
                </div>
            </li>
            {{/each}}
        </ol>

        {{#if user.isGM}}
        <footer>
            {{#if round}}
            <a class="combat-control" data-control="previousRound" title="{{localize 'COMBAT.RoundPrev'}}">
                <i class="fas fa-step-backward"></i>
            </a>
            <a class="combat-control" data-control="previousTurn" title="{{localize 'COMBAT.TurnPrev'}}">
                <i class="fas fa-arrow-left"></i>
            </a>
            <a class="combat-control" data-control="endCombat"> {{localize 'COMBAT.End'}} </a>
            <a class="combat-control" data-control="nextTurn" title="{{localize 'COMBAT.TurnNext'}}">
                <i class="fas fa-arrow-right"></i>
            </a>
            <a class="combat-control" data-control="nextRound" title="{{localize 'COMBAT.RoundNext'}}">
                <i class="fas fa-step-forward"></i>
            </a>
            {{else}}
            <a class="combat-control" data-control="startCombat" title="{{localize 'COMBAT.Begin'}}">
                {{localize 'COMBAT.Begin'}}
            </a>
            {{/if}}
        </footer>
        {{else if allowEndTurn}}
        <footer>
            <a class="combat-control{{#unless canEndTurn}} disabled{{/unless}}" data-control="nextTurn">
                {{localize 'COMBAT.TurnEnd'}}
            </a>
        </footer>
        {{/if}}
    </div>
    {{/if}}
</div>
